@using Microsoft.AspNetCore.Components.Services
@using RazorComponentsRealworld.Model
@page "/editor"
@page "/editor/{Slug}"
@inject ApiClient api
@inject IUriHelper uriHelper

@if (articleModel != null)
{
    <div class="editor-page">
        <div class="container page">
            <div class="row">

                <div class="col-md-10 offset-md-1 col-xs-12">
                    <ErrorMessages Errors=@response.errors />
                    <form>
                        <fieldset>
                            <fieldset class="form-group">
                                <input type="text" class="form-control form-control-lg" placeholder="Article Title" bind="@articleModel.Title" />
                            </fieldset>
                            <fieldset class="form-group">
                                <input type="text" class="form-control" placeholder="What's this article about?" bind="@articleModel.Description" />
                            </fieldset>
                            <fieldset class="form-group">
                                <textarea class="form-control" rows="8" placeholder="Write your article (in markdown)" bind="@articleModel.Body">@articleModel.Body</textarea>
                            </fieldset>
                            <fieldset class="form-group">
                                <input type="text" class="form-control" placeholder="Enter tags" bind="@tagString" /><div class="tag-list"></div>
                            </fieldset>
                            <button class="btn btn-lg pull-xs-right btn-primary" type="button" onclick="@Submit">
                                Publish
                            </button>
                        </fieldset>
                    </form>
                </div>

            </div>
        </div>
    </div>
}

@functions
{
    [Parameter]
    public string Slug { get; set; }

    ArticleModel articleModel = null;
    ArticleResponse response = new ArticleResponse();
    string tagString = "";

    protected override async Task OnInitAsync()
    {
        if (Slug == null)
        {
            articleModel = new ArticleModel();
        }
        else
        {
            articleModel = await api.GetArticleAsync(Slug);
        }
    }

    async Task Submit()
    {
        articleModel.TagList = tagString.Split(' ');
        response = await api.SaveArticleAsync(articleModel);
        var postedArticle = response?.article;

        if (postedArticle != null)
        {
            uriHelper.NavigateTo($"/article/{postedArticle.Slug}");
        }
        else
            // Show errors
            StateHasChanged();
    }
}
